# Traefik Routers - Traffic Routing Rules
#
# SECURITY MODEL: Explicit Private/Public
# - All internal services use private-default middleware (IP restricted)
# - Public services use public-access middleware (internet accessible)
# - Must explicitly choose middleware for each service

http:
  # Routers match incoming requests and decide where to send them
  routers:
    # ============================================================================
    # PRIVATE SERVICES - Internal access only (home network + NetBird VPN)
    # ============================================================================

    # Authentik (SSO) - no auth middleware on itself
    authentik:
      rule: "Host(`auth.onurx.com`)"
      entryPoints:
        - websecure
      service: authentik-svc
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Traefik Dashboard (internal use only - home network)
    traefik-dashboard:
      rule: "Host(`traefik.onurx.com`)"
      entryPoints:
        - websecure
      service: traefik-dashboard
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # AdGuard Home (DNS management)
    adguard:
      rule: "Host(`adguard.onurx.com`)"
      entryPoints:
        - websecure
      service: adguard
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Proxmox (Hypervisor management)
    proxmox:
      rule: "Host(`proxmox.onurx.com`)"
      entryPoints:
        - websecure
      service: proxmox
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Synology NAS (Storage management)
    synology:
      rule: "Host(`synology.onurx.com`)"
      entryPoints:
        - websecure
      service: synology
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Portainer
    portainer:
      rule: "Host(`portainer.onurx.com`)"
      entryPoints:
        - websecure
      service: portainer
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Grafana
    grafana:
      rule: "Host(`grafana.onurx.com`)"
      entryPoints:
        - websecure
      service: grafana
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Prometheus
    prometheus:
      rule: "Host(`prometheus.onurx.com`)"
      entryPoints:
        - websecure
      service: prometheus
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Loki (API access - optional, mainly used internally)
    loki:
      rule: "Host(`loki.onurx.com`)"
      entryPoints:
        - websecure
      service: loki
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Alloy (Web UI - optional, for debugging)
    alloy:
      rule: "Host(`alloy.onurx.com`)"
      entryPoints:
        - websecure
      service: alloy
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Glance (Homelab Dashboard)
    glance:
      rule: "Host(`home.onurx.com`)"
      entryPoints:
        - websecure
      service: glance
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Gitea (Git + Container Registry + CI/CD)
    gitea:
      rule: "Host(`git.onurx.com`)"
      entryPoints:
        - websecure
      service: gitea
      middlewares:
        - private-default
        - forwarded-headers
      tls:
        certResolver: cloudflare

    # Hoppscotch (API Development & Testing)
    hoppscotch:
      rule: "Host(`api.onurx.com`)"
      entryPoints:
        - websecure
      service: hoppscotch
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # SonarQube (Code Quality & Security)
    sonarqube:
      rule: "Host(`sonar.onurx.com`)"
      entryPoints:
        - websecure
      service: sonarqube
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Meilisearch (Search Engine)
    meilisearch:
      rule: "Host(`search.onurx.com`)"
      entryPoints:
        - websecure
      service: meilisearch
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Inngest (AI/Workflow Orchestration)
    inngest:
      rule: "Host(`inngest.onurx.com`)"
      entryPoints:
        - websecure
      service: inngest
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Coolify (Deployment Platform) - Public (has own auth)
    coolify:
      rule: "Host(`deploy.onurx.com`)"
      entryPoints:
        - websecure
      service: coolify
      middlewares:
        - public-access
        - forwarded-headers
      tls:
        certResolver: cloudflare

    # MinIO Console
    minio-console:
      rule: "Host(`minio.onurx.com`)"
      entryPoints:
        - websecure
      service: minio-console
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # MinIO API (S3)
    minio-api:
      rule: "Host(`s3.onurx.com`)"
      entryPoints:
        - websecure
      service: minio-api
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # RabbitMQ Management UI
    rabbitmq:
      rule: "Host(`rabbitmq.onurx.com`)"
      entryPoints:
        - websecure
      service: rabbitmq
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # ============================================================================
    # MEDIA SERVICES (VM 113) - Private access only
    # ============================================================================

    # Plex (Media Server)
    plex:
      rule: "Host(`plex.onurx.com`)"
      entryPoints:
        - websecure
      service: plex
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Jellyfin (Media Server - Open Source)
    jellyfin:
      rule: "Host(`jellyfin.onurx.com`)"
      entryPoints:
        - websecure
      service: jellyfin
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Overseerr (Request/Discovery UI)
    overseerr:
      rule: "Host(`overseerr.onurx.com`)"
      entryPoints:
        - websecure
      service: overseerr
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Seerr (Modern Request/Discovery UI - Overseerr Fork)
    seerr:
      rule: "Host(`seerr.onurx.com`)"
      entryPoints:
        - websecure
      service: seerr
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Sonarr (TV Shows)
    sonarr:
      rule: "Host(`sonarr.onurx.com`)"
      entryPoints:
        - websecure
      service: sonarr
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Radarr (Movies)
    radarr:
      rule: "Host(`radarr.onurx.com`)"
      entryPoints:
        - websecure
      service: radarr
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Prowlarr (Indexer Manager)
    prowlarr:
      rule: "Host(`prowlarr.onurx.com`)"
      entryPoints:
        - websecure
      service: prowlarr
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # SABnzbd (Usenet Downloader)
    sabnzbd:
      rule: "Host(`sabnzbd.onurx.com`)"
      entryPoints:
        - websecure
      service: sabnzbd
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # qBittorrent (Torrent Downloader)
    qbittorrent:
      rule: "Host(`qbittorrent.onurx.com`)"
      entryPoints:
        - websecure
      service: qbittorrent
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Bazarr (Subtitles)
    bazarr:
      rule: "Host(`bazarr.onurx.com`)"
      entryPoints:
        - websecure
      service: bazarr
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Notifiarr (TRaSH Sync)
    notifiarr:
      rule: "Host(`notifiarr.onurx.com`)"
      entryPoints:
        - websecure
      service: notifiarr
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Tautulli (Plex Monitoring)
    tautulli:
      rule: "Host(`tautulli.onurx.com`)"
      entryPoints:
        - websecure
      service: tautulli
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # ============================================================================
    # PUBLIC SERVICES - Explicitly accessible from internet
    # ============================================================================
    # These services use public-access middleware (no IP restriction)

    # Home Assistant (OLD - pointing to 10.10.10.13)
    homeassistant:
      rule: "Host(`ha.onurx.com`)"
      entryPoints:
        - websecure
      service: homeassistant
      middlewares:
        - public-access
      tls:
        certResolver: cloudflare

    # DMO (OLD Coolify app)
    dmo:
      rule: "Host(`dmo.onurx.com`)"
      entryPoints:
        - websecure
      service: dmo
      middlewares:
        - public-access
      tls:
        certResolver: cloudflare

    # King Game (OLD - HTTP + WebSocket)
    # No middlewares - Traefik v3 handles WebSocket upgrades automatically
    # Security headers interfere with WebSocket connections
    king:
      rule: "Host(`king.onurx.com`)"
      entryPoints:
        - websecure
      service: king
      tls:
        certResolver: cloudflare

    # King Game WebSocket (OLD) - Points to backend on port 3015
    # No middlewares - Traefik v3 handles WebSocket upgrades automatically
    wsking:
      rule: "Host(`wsking.onurx.com`)"
      entryPoints:
        - websecure
      service: king-backend
      tls:
        certResolver: cloudflare

    # ============================================================================
    # AI SERVICES
    # ============================================================================

    # LiteLLM - AI Gateway (private)
    litellm:
      rule: "Host(`litellm.onurx.com`)"
      entryPoints:
        - websecure
      service: litellm
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # n8n - Workflow Automation (private)
    n8n:
      rule: "Host(`n8n.onurx.com`)"
      entryPoints:
        - websecure
      service: n8n
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Open WebUI - Chat Interface (private)
    chat:
      rule: "Host(`chat.onurx.com`)"
      entryPoints:
        - websecure
      service: open-webui
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Langfuse - AI Observability (private)
    langfuse:
      rule: "Host(`langfuse.onurx.com`)"
      entryPoints:
        - websecure
      service: langfuse
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare

    # Docling - Document Processing API (private)
    docling:
      rule: "Host(`docling.onurx.com`)"
      entryPoints:
        - websecure
      service: docling
      middlewares:
        - private-default
      tls:
        certResolver: cloudflare
