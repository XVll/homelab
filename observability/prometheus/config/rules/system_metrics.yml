groups:
  - name: normalized_system_metrics
    interval: 10s
    rules:
      # ========================================================================
      # CPU Usage - Normalized to ratio (0.0 - 1.0)
      # ========================================================================

      # Docker VMs (edge, db, observability, etc.)
      - record: system:cpu_usage:ratio
        expr: |
          1 - avg by (instance, system_name, system_type, job) (
            irate(node_cpu_seconds_total{job="integrations/unix", mode="idle"}[1m])
          )

      # Synology NAS
      - record: system:cpu_usage:ratio
        expr: |
          label_replace(
            (100 - ssCpuIdle{job=~"integrations/snmp.*"}) / 100,
            "job", "integrations/snmp", "", ""
          )

      # Home Assistant (System Monitor integration sensor)
      - record: system:cpu_usage:ratio
        expr: |
          sum by (instance, system_name, system_type, job) (
            homeassistant_sensor_unit_percent{job="integrations/homeassistant", entity="sensor.system_monitor_processor_use"} / 100
          )

      # ========================================================================
      # Memory Usage - Normalized to ratio (0.0 - 1.0)
      # ========================================================================

      # Docker VMs
      - record: system:memory_usage:ratio
        expr: |
          1 - (
            avg by (instance, system_name, system_type, job) (node_memory_MemAvailable_bytes{job="integrations/unix"})
            /
            avg by (instance, system_name, system_type, job) (node_memory_MemTotal_bytes{job="integrations/unix"})
          )

      # Synology (SNMP metrics are in KB, convert to ratio)
      - record: system:memory_usage:ratio
        expr: |
          label_replace(
            (memTotalReal{job=~"integrations/snmp.*"} - memAvailReal{job=~"integrations/snmp.*"})
            / memTotalReal{job=~"integrations/snmp.*"},
            "job", "integrations/snmp", "", ""
          )

      # Home Assistant (System Monitor integration sensor)
      - record: system:memory_usage:ratio
        expr: |
          sum by (instance, system_name, system_type, job) (
            homeassistant_sensor_unit_percent{job="integrations/homeassistant", entity="sensor.system_monitor_memory_usage"} / 100
          )

      # ========================================================================
      # Disk Usage - Normalized to ratio (0.0 - 1.0)
      # ========================================================================

      # Docker VMs (root filesystem)
      - record: system:disk_usage:ratio
        expr: |
          (
            node_filesystem_size_bytes{job="integrations/unix", mountpoint="/host/root", fstype="ext4"}
            - node_filesystem_avail_bytes{job="integrations/unix", mountpoint="/host/root", fstype="ext4"}
          ) / node_filesystem_size_bytes{job="integrations/unix", mountpoint="/host/root", fstype="ext4"}

      # Synology (RAID storage usage - Volume 1 only, main data storage)
      - record: system:disk_usage:ratio
        expr: |
          label_replace(
            sum by (instance, system_name, system_type) (
              (raidTotalSize{job=~"integrations/snmp.*", raidName="Volume 1"} - raidFreeSize{job=~"integrations/snmp.*", raidName="Volume 1"})
              / raidTotalSize{job=~"integrations/snmp.*", raidName="Volume 1"}
            ),
            "job", "integrations/snmp", "", ""
          )

      # Home Assistant (System Monitor integration sensor)
      - record: system:disk_usage:ratio
        expr: |
          sum by (instance, system_name, system_type, job) (
            homeassistant_sensor_unit_percent{job="integrations/homeassistant", entity="sensor.system_monitor_disk_usage"} / 100
          )

      # ========================================================================
      # Network I/O - Normalized to bytes per second
      # ========================================================================

      # Docker VMs
      - record: system:network_io:bytes_per_sec
        expr: |
          sum by (instance, system_name, system_type, job) (
            rate(node_network_receive_bytes_total{job="integrations/unix", device!~"lo|docker.*|veth.*|br-.*"}[1m])
          ) +
          sum by (instance, system_name, system_type, job) (
            rate(node_network_transmit_bytes_total{job="integrations/unix", device!~"lo|docker.*|veth.*|br-.*"}[1m])
          )

      # Synology (ifHCInOctets + ifHCOutOctets - High Capacity counters)
      - record: system:network_io:bytes_per_sec
        expr: |
          label_replace(
            sum by (instance, system_name, system_type) (
              rate(ifHCInOctets{job=~"integrations/snmp.*", ifName!~"lo|docker.*|sit.*"}[1m])
            ) +
            sum by (instance, system_name, system_type) (
              rate(ifHCOutOctets{job=~"integrations/snmp.*", ifName!~"lo|docker.*|sit.*"}[1m])
            ),
            "job", "integrations/snmp", "", ""
          )

      # Home Assistant (System Monitor integration sensors - MB/s to bytes/sec)
      - record: system:network_io:bytes_per_sec
        expr: |
          sum by (instance, system_name, system_type, job) (
            homeassistant_sensor_data_rate_mb_per_s{job="integrations/homeassistant", entity=~"sensor.system_monitor_network_throughput_(in|out)_enp6s18"}
          ) * 1000000

      # ========================================================================
      # Disk I/O - Normalized to bytes per second
      # ========================================================================

      # Docker VMs
      - record: system:disk_io:bytes_per_sec
        expr: |
          sum by (instance, system_name, system_type, job) (
            rate(node_disk_read_bytes_total{job="integrations/unix"}[1m])
          ) +
          sum by (instance, system_name, system_type, job) (
            rate(node_disk_written_bytes_total{job="integrations/unix"}[1m])
          )

      # Synology (spaceIONReadX + spaceIONWrittenX - Extended counters)
      - record: system:disk_io:bytes_per_sec
        expr: |
          label_replace(
            sum by (instance, system_name, system_type) (
              rate(spaceIONReadX{job=~"integrations/snmp.*"}[1m])
            ) +
            sum by (instance, system_name, system_type) (
              rate(spaceIONWrittenX{job=~"integrations/snmp.*"}[1m])
            ),
            "job", "integrations/snmp", "", ""
          )

      # Home Assistant - Get disk I/O from Proxmox (by VM name)
      # Note: HA has very low disk activity, may show 0 or low values when idle
      # Using same 1m window as other systems for consistency
      - record: system:disk_io:bytes_per_sec
        expr: |
          label_replace(
            label_replace(
              label_replace(
                (
                  rate(pve_disk_read_bytes{vm_name="ha"}[1m]) +
                  rate(pve_disk_write_bytes{vm_name="ha"}[1m])
                ) or
                vector(0),
                "instance", "ha", "", ""
              ),
              "system_name", "ha", "", ""
            ),
            "system_type", "automation", "", ""
          )

      # ========================================================================
      # Load Average - 1 minute
      # ========================================================================

      # Docker VMs
      - record: system:load1
        expr: |
          node_load1{job="integrations/unix"}

      # Synology (laLoadInt is scaled by 100, e.g., 123 = 1.23)
      - record: system:load1
        expr: |
          label_replace(
            laLoadInt{job=~"integrations/snmp.*", laNames="Load-1"} / 100,
            "job", "integrations/snmp", "", ""
          )

      # Home Assistant (System Monitor integration sensor)
      - record: system:load1
        expr: |
          sum by (instance, system_name, system_type, job) (
            homeassistant_sensor_state{job="integrations/homeassistant", entity="sensor.system_monitor_load_1_min"}
          )

      # ========================================================================
      # Load Average - 5 minute
      # ========================================================================

      # Docker VMs
      - record: system:load5
        expr: |
          node_load5{job="integrations/unix"}

      # Synology (laLoadInt is scaled by 100, e.g., 123 = 1.23)
      - record: system:load5
        expr: |
          label_replace(
            laLoadInt{job=~"integrations/snmp.*", laNames="Load-5"} / 100,
            "job", "integrations/snmp", "", ""
          )

      # Home Assistant (System Monitor integration sensor)
      - record: system:load5
        expr: |
          sum by (instance, system_name, system_type, job) (
            homeassistant_sensor_state{job="integrations/homeassistant", entity="sensor.system_monitor_load_5_min"}
          )

      # ========================================================================
      # Load Average - 15 minute
      # ========================================================================

      # Docker VMs
      - record: system:load15
        expr: |
          node_load15{job="integrations/unix"}

      # Synology (laLoadInt is scaled by 100, e.g., 123 = 1.23)
      - record: system:load15
        expr: |
          label_replace(
            laLoadInt{job=~"integrations/snmp.*", laNames="Load-15"} / 100,
            "job", "integrations/snmp", "", ""
          )

      # Home Assistant (System Monitor integration sensor)
      - record: system:load15
        expr: |
          sum by (instance, system_name, system_type, job) (
            homeassistant_sensor_state{job="integrations/homeassistant", entity="sensor.system_monitor_load_15_min"}
          )

      # ========================================================================
      # System Status - 1 = up, 0 = down
      # ========================================================================

      - record: system:up
        expr: up{job=~"integrations/(unix|snmp.*|homeassistant)"}
