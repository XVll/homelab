# DATA HOST: Databases + Message Broker
# Build services one at a time in this order:
# 1. MongoDB (document database)
# 2. PostgreSQL (relational database)
# 3. Redis (cache & sessions)
# 4. MinIO (object storage)
# 5. Mosquitto MQTT (message broker)

services:
  # ============================================================================
  # PORTAINER AGENT - Container Management
  # ============================================================================
  # Connects to Portainer on observability VM (10.10.10.112:9443)

  portainer-agent:
    image: portainer/agent:latest
    container_name: portainer-agent
    restart: always
    ports:
      - "9001:9001"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
      - /:/host
    networks:
      - data_net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # ALLOY - Metrics & Logs Collector (sends to observability VM)
  # ============================================================================

  alloy:
    image: grafana/alloy:v1.11.2
    container_name: alloy
    restart: unless-stopped
    privileged: true  # Required for system metrics collection
    command:
      - run
      - /etc/alloy/config.alloy
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
    ports:
      - "10.10.10.111:12345:12345"  # Alloy UI
    volumes:
      - ./alloy/config/config.alloy:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker metrics + logs
      - /:/host/root:ro  # System metrics (CPU, disk, etc.)
      - /sys:/host/sys:ro  # System metrics
      - /proc:/host/proc:ro  # System metrics
      - /var/lib/docker:/var/lib/docker:ro  # Docker container info for cAdvisor
      - /dev/disk:/dev/disk:ro  # Disk info for cAdvisor
      - /sys/fs/cgroup:/sys/fs/cgroup:ro  # cgroups for container metrics
      - ./alloy/data:/var/lib/alloy/data  # Alloy state
    networks:
      - data_net
    environment:
      - HOSTNAME=db
    healthcheck:
      test: ["CMD-SHELL", "alloy tools pprof health http://localhost:12345 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # NETDATA - Real-Time System & Container Monitoring
  # ============================================================================
  # Real-time performance monitoring with 1-second granularity
  # Streams to parent on observability VM (10.10.10.112)
  # Web UI: http://10.10.10.111:19999
  # Documentation: https://learn.netdata.cloud

  netdata:
    image: netdata/netdata:latest
    container_name: netdata
    hostname: db
    restart: unless-stopped
    pid: host
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    ports:
      - "10.10.10.111:19999:19999"
    volumes:
      - ./netdata/config:/etc/netdata
      - ./netdata/lib:/var/lib/netdata
      - ./netdata/cache:/var/cache/netdata
      - /:/host/root:ro,rslave
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /etc/localtime:/etc/localtime:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/log:/host/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - data_net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 1. MONGODB - Document Database
  # ============================================================================
  # Deploy first - used by Komodo, other apps
  # Access: mongodb://10.10.10.111:27017

  mongodb:
    image: mongo:8
    container_name: mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD}
    ports:
      - "10.10.10.111:27017:27017"
    volumes:
      - ./mongodb/data:/data/db
      - ./mongodb/config/mongod.conf:/etc/mongod.conf:ro
      - ./mongodb/certs:/certs:ro
    command: ["--config", "/etc/mongod.conf"]
    networks:
      - data_net
    healthcheck:
      test: ["CMD", "mongosh", "--host", "localhost", "--port", "27017", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 2. POSTGRESQL - Relational Database
  # ============================================================================
  # Used by: Authentik, Grafana, n8n, Paperless, custom apps

  postgres:
    image: postgres:17-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: postgres
    ports:
      - "10.10.10.111:5432:5432"
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
      - ./postgres/config/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./postgres/config/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./postgres/certs:/certs:ro
    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
    networks:
      - data_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 3. REDIS - Cache & Session Storage
  # ============================================================================
  # Used by: Authentik, Paperless, caching layers

  redis:
    image: redis:8-alpine
    container_name: redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --appendonly yes
    ports:
      - "10.10.10.111:6379:6379"
    volumes:
      - ./redis/data:/data
      - ./redis/certs:/certs:ro
    networks:
      - data_net
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 4. MINIO - S3-Compatible Object Storage
  # ============================================================================
  # Used by: Loki (logs), backups, object storage needs

  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9002"
    ports:
      - "10.10.10.111:9000:9000"  # S3 API
      - "10.10.10.111:9002:9002"  # Web Console
    volumes:
      - ./minio/data:/data
      - ./minio/certs:/certs:ro
    networks:
      - data_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 5. MOSQUITTO - MQTT Message Broker
  # ============================================================================
  # Used by: Home Assistant bridge application, IoT devices
  # Access: mqtt://10.10.10.111:1883

  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "10.10.10.111:1883:1883"  # MQTT
      - "10.10.10.111:9003:9001"  # WebSockets (optional)
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - data_net
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -i healthcheck -W 3 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  data_net:
    driver: bridge

volumes:
  mongodb_data:
  # postgres_data:
  # redis_data:
  # minio_data:
